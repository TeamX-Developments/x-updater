<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project X Updater</title>
  <style>
    :root{
      --bg1:#0b1020; --bg2:#070a12;
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.72);
      --bd:rgba(255,255,255,.14);
      --card:rgba(255,255,255,.07);
      --card2:rgba(255,255,255,.04);
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --p1:#6366f1; --p2:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--txt); overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 15% 20%, rgba(125,211,252,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 70%, rgba(167,139,250,.16), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }
    code, pre{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;
      padding:16px;border:1px solid var(--bd);
      background:linear-gradient(180deg,var(--card),var(--card2));
      border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);backdrop-filter:blur(10px)
    }
    .brand{display:flex;align-items:center;gap:12px}
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:
        radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 35%, rgba(255,255,255,0) 70%),
        linear-gradient(180deg, rgba(99,102,241,1), rgba(34,197,94,1));
      box-shadow:0 0 18px rgba(99,102,241,.55),0 0 22px rgba(34,197,94,.25)
    }
    .title{font-weight:950;font-size:18px}
    .sub{color:var(--mut);font-size:12px;line-height:1.35;margin-top:2px}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--bd);
      background:rgba(255,255,255,.05);font-size:12px;display:inline-flex;gap:8px;align-items:center
    }
    .dot2{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25)}
    .dot2.ok{background:var(--ok)}
    .dot2.bad{background:var(--bad)}
    .dot2.warn{background:var(--warn)}

    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--bd);
      background:linear-gradient(180deg,var(--card),var(--card2));
      border-radius:18px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.28);backdrop-filter:blur(10px)
    }
    h3{margin:0;font-size:14px;font-weight:950;opacity:.95}
    .muted{color:var(--mut);font-size:12px}
    label{display:block;color:var(--mut);font-size:11px;margin:10px 0 6px}
    input{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);
      background:rgba(255,255,255,.05);color:var(--txt);outline:none
    }
    input:focus{border-color:rgba(99,102,241,.7);box-shadow:0 0 0 3px rgba(99,102,241,.18)}
    .minirow{display:grid;grid-template-columns:1.2fr .7fr .7fr .7fr;gap:10px;margin-top:10px}
    @media (max-width: 980px){.minirow{grid-template-columns:1fr 1fr}}
    @media (max-width: 620px){.minirow{grid-template-columns:1fr}}
    .meta{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .k{border:1px solid var(--bd);background:rgba(255,255,255,.04);border-radius:14px;padding:10px;min-height:56px}
    .lbl{font-size:11px;color:var(--mut)}
    .val{margin-top:5px;font-size:13px;font-weight:950;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid var(--bd);background:rgba(255,255,255,.06);color:var(--txt);
      padding:10px 12px;border-radius:12px;font-weight:950;cursor:pointer;
      transition:transform .08s ease,background .2s ease,border-color .2s ease,opacity .2s ease
    }
    button:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.22)}
    button:active{transform:translateY(1px)}
    button.primary{background:linear-gradient(180deg, rgba(99,102,241,.45), rgba(34,197,94,.18));border-color:rgba(99,102,241,.55)}
    button.danger{background:linear-gradient(180deg, rgba(239,68,68,.28), rgba(0,0,0,.02));border-color:rgba(239,68,68,.35)}
    button:disabled{opacity:.45;cursor:not-allowed}

    .bar{margin-top:12px;border:1px solid var(--bd);background:rgba(0,0,0,.18);border-radius:999px;height:12px;overflow:hidden}
    .fill{height:100%;width:0%;background:linear-gradient(90deg, var(--p1), var(--p2));border-radius:999px;transition:width .25s ease}
    .log{
      margin-top:12px;border:1px solid var(--bd);background:rgba(0,0,0,.18);border-radius:14px;padding:12px;
      height:250px;overflow:auto;font-size:12px;line-height:1.45;white-space:pre-wrap
    }
    details{
      margin-top:12px;border:1px solid var(--bd);background:rgba(255,255,255,.04);
      border-radius:14px;padding:10px
    }
    summary{cursor:pointer;font-weight:950;list-style:none}
    summary::-webkit-details-marker{display:none}
    .supportGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .supportBox{
      border:1px solid var(--bd);background:rgba(0,0,0,.14);border-radius:12px;padding:10px
    }
    .supportBox h4{margin:0 0 6px 0;font-size:12px;font-weight:950}
    .supportBox ul{margin:8px 0 0 18px;padding:0;color:rgba(255,255,255,.86);font-size:12px;line-height:1.5}
    .toast{
      position:fixed;right:16px;bottom:16px;max-width:360px;
      border:1px solid var(--bd);background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
      border-radius:14px;padding:10px 12px;font-size:12px;color:rgba(255,255,255,.9);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
      opacity:0;transform:translateY(6px);pointer-events:none;
      transition:opacity .18s ease,transform .18s ease;
    }
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Project X Updater</div>
          <div class="sub">
            Server: <code>localhost:8787</code> • Install applies to <code>./app</code> (server folder) then restarts.
          </div>
        </div>
      </div>
      <div class="pill"><span class="dot2 warn" id="srvDot"></span><span id="serverLbl">…</span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <h3>Update Status</h3>
          <div class="pill" id="statusPill">starting…</div>
        </div>

        <div class="minirow">
          <div>
            <label>Updates server</label>
            <input id="serverInput" placeholder="http://localhost:8787" />
          </div>
          <div>
            <label>Channel</label>
            <input id="channelInput" placeholder="stable" />
          </div>
          <div>
            <label>Current version</label>
            <input id="currentInput" placeholder="1.0.0" />
          </div>
          <div>
            <label>Staging dest</label>
            <input id="destInput" placeholder="current" />
          </div>
        </div>

        <div class="meta">
          <div class="k"><div class="lbl">Current</div><div class="val" id="curVer">--</div></div>
          <div class="k"><div class="lbl">Latest</div><div class="val" id="latVer">--</div></div>
          <div class="k"><div class="lbl">Published</div><div class="val" id="pub">--</div></div>
          <div class="k"><div class="lbl">Update Available</div><div class="val" id="avail">--</div></div>
        </div>

        <div class="actions">
          <button class="primary" id="pingBtn">Ping</button>
          <button class="primary" id="checkBtn">Check</button>
          <button id="installBtn" disabled>Install + Apply + Restart</button>
          <button class="danger" id="wipeInstallBtn" disabled>Wipe + Install + Apply + Restart</button>
        </div>

        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="log" id="log"></div>

        <!-- SUPPORT -->
        <details id="supportPanel">
          <summary>Support</summary>
          <div class="supportGrid">
            <div class="supportBox">
              <h4>Quick actions</h4>
              <div class="actions" style="margin-top:8px">
                <button id="copyDiagBtn">Copy diagnostics</button>
                <button id="downloadLogBtn">Download logs</button>
                <button class="danger" id="resetUiBtn">Reset UI</button>
              </div>
              <div class="muted" style="margin-top:8px">
                If you’re going to ask for help, paste the diagnostics. Otherwise it’s just interpretive whining.
              </div>
            </div>

            <div class="supportBox">
              <h4>Troubleshooting checklist</h4>
              <ul>
                <li>Is the updates server running? Try <code>Ping</code> (hits <code>/health</code>).</li>
                <li>If you see <code>&lt;!doctype html&gt;</code> in errors, you hit the wrong port or wrong route.</li>
                <li>Make sure the server implements install apply: <code>apply=1&amp;target=app</code>.</li>
                <li>Make sure the update zip exists and your channel entry in <code>updates.json</code> points to it.</li>
                <li>If install worked but app looks unchanged, you probably applied to the wrong folder.</li>
              </ul>
            </div>

            <div class="supportBox">
              <h4>What this page does</h4>
              <div class="muted">
                Check: <code>/v2/updates/check</code><br>
                Install: <code>/v2/updates/install</code> with <code>apply=1&amp;target=app</code><br>
                Restart: calls <code>window.px.restartApp()</code> (only works inside Electron)
              </div>
            </div>
          </div>
        </details>
      </div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <h3>Release Notes</h3>
          <div class="muted">from server</div>
        </div>
        <div class="log" id="notes"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const el = (id) => document.getElementById(id);

  const logEl = el("log");
  const notesEl = el("notes");
  const fillEl = el("fill");
  const statusPill = el("statusPill");

  const pingBtn = el("pingBtn");
  const checkBtn = el("checkBtn");
  const installBtn = el("installBtn");
  const wipeInstallBtn = el("wipeInstallBtn");

  const curVerEl = el("curVer");
  const latVerEl = el("latVer");
  const pubEl = el("pub");
  const availEl = el("avail");

  const serverLbl = el("serverLbl");
  const srvDot = el("srvDot");

  const serverInput = el("serverInput");
  const channelInput = el("channelInput");
  const currentInput = el("currentInput");
  const destInput = el("destInput");

  const copyDiagBtn = el("copyDiagBtn");
  const downloadLogBtn = el("downloadLogBtn");
  const resetUiBtn = el("resetUiBtn");
  const toastEl = el("toast");

  const qs = new URLSearchParams(location.search);

  // Support state
  const supportState = {
    lastError: null,
    lastPing: null,
    lastCheck: null,
    lastInstall: null
  };

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 1600);
  }

  function wlog(s){
    const t = new Date().toLocaleTimeString();
    logEl.textContent += `[${t}] ${s}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setFill(p){
    const v = Math.max(0, Math.min(100, Number(p) || 0));
    fillEl.style.width = v + "%";
  }

  function setStatus(text){ statusPill.textContent = text; }

  function setServerState(state){
    srvDot.classList.remove("ok","bad","warn");
    srvDot.classList.add(state);
  }

  function normBase(s){ return String(s || "").trim().replace(/\/+$/, ""); }

  function getCfg(){
    const server = normBase(serverInput.value) || "http://localhost:8787";
    const channel = (channelInput.value || "").trim().toLowerCase() || "stable";
    const current = (currentInput.value || "").trim() || "unknown";
    const dest = (destInput.value || "").trim() || "current";
    return { server, channel, current, dest };
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache: "no-store" });
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const txt = await res.text();

    if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0,200)}`);
    if (!ct.includes("application/json")) throw new Error(`Expected JSON, got ${ct || "unknown"}: ${txt.slice(0,200)}`);

    return JSON.parse(txt);
  }

  function setButtons(updateAvailable){
    const ok = !!updateAvailable;
    installBtn.disabled = !ok;
    wipeInstallBtn.disabled = !ok;
  }

  function updateServerLabel(){
    const base = normBase(serverInput.value) || "—";
    serverLbl.textContent = base;
  }

  async function ping(){
    const { server } = getCfg();
    setStatus("Pinging…"); setFill(12);
    const url = server + "/health";
    wlog("GET " + url);

    const data = await fetchJson(url);

    supportState.lastPing = data;
    supportState.lastError = null;

    setServerState("ok");
    setStatus("Online");
    setFill(100);
    wlog(`OK: ${data.service} @ ${data.port}`);
    return data;
  }

  async function check(){
    const { server, channel, current } = getCfg();
    setStatus("Checking…");
    setButtons(false);
    setFill(10);

    curVerEl.textContent = current;

    const url = `${server}/v2/updates/check?channel=${encodeURIComponent(channel)}&current=${encodeURIComponent(current)}`;
    wlog("GET " + url);

    const res = await fetchJson(url);

    supportState.lastCheck = res;
    supportState.lastError = null;

    latVerEl.textContent = res.latest ?? "--";
    pubEl.textContent = res.published ?? "--";
    notesEl.textContent = res.notes ?? "";
    availEl.textContent = String(!!res.updateAvailable);

    setButtons(!!res.updateAvailable);

    setStatus(res.status || (res.updateAvailable ? "Update available" : "Up to date"));
    setFill(100);
    wlog("Check done.");
    return res;
  }

  async function install(wipe){
    const { server, channel, dest } = getCfg();

    setStatus(wipe ? "Wipe + Installing…" : "Installing…");
    setFill(15);

    installBtn.disabled = true;
    wipeInstallBtn.disabled = true;

    // Apply to ./app (relative to updates server folder)
    const url =
      `${server}/v2/updates/install?channel=${encodeURIComponent(channel)}` +
      `&dest=${encodeURIComponent(dest)}` +
      `&wipe=${wipe ? "1" : "0"}` +
      `&apply=1&target=app`;

    wlog("GET " + url);

    const res = await fetchJson(url);

    supportState.lastInstall = res;
    supportState.lastError = null;

    setFill(100);

    if (res.ok) {
      setStatus("Installed");
      wlog(`Staged: ${res.installed_to}`);
      if (res.applied) wlog(`Applied to: ${res.applied_to || "app"}`);
      wlog(`Entries extracted: ${res.entries}`);

      if (window.px && typeof window.px.restartApp === "function") {
        setStatus("Restarting…");
        wlog("Restart requested.");
        setTimeout(() => window.px.restartApp(), 800);
      } else {
        wlog("Restart not available (not running inside Electron).");
        setButtons(true);
      }
    } else {
      setStatus("Failed");
      wlog("Install failed: " + (res.error || "unknown"));
      setButtons(true);
    }

    return res;
  }

  function fail(err){
    const msg = err?.message || String(err);
    supportState.lastError = msg;

    setServerState("bad");
    setStatus("Offline / Failed");
    setFill(100);
    wlog(msg);
  }

  function buildDiagnostics(){
    const { server, channel, current, dest } = getCfg();
    const diag = {
      time: new Date().toISOString(),
      location: location.href,
      userAgent: navigator.userAgent,
      config: { server, channel, current, stagingDest: dest, applyTarget: "app", apply: true },
      ui: {
        status: statusPill.textContent,
        serverDot: srvDot.className,
        currentShown: curVerEl.textContent,
        latestShown: latVerEl.textContent,
        publishedShown: pubEl.textContent,
        updateAvailableShown: availEl.textContent
      },
      lastPing: supportState.lastPing,
      lastCheck: supportState.lastCheck,
      lastInstall: supportState.lastInstall,
      lastError: supportState.lastError
    };
    return diag;
  }

  async function copyDiagnostics(){
    const diag = buildDiagnostics();
    const text = JSON.stringify(diag, null, 2);
    try{
      await navigator.clipboard.writeText(text);
      toast("Diagnostics copied");
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("Diagnostics copied (fallback)");
    }
  }

  function downloadLogs(){
    const diag = buildDiagnostics();
    const content =
      "=== Project X Updater Log ===\n\n" +
      "Diagnostics:\n" + JSON.stringify(diag, null, 2) + "\n\n" +
      "Log:\n" + logEl.textContent + "\n";
    const blob = new Blob([content], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "updater-log.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
    toast("Downloaded logs");
  }

  function resetUi(){
    logEl.textContent = "";
    notesEl.textContent = "";
    setFill(0);
    setButtons(false);
    setServerState("warn");
    setStatus("reset");
    supportState.lastError = null;
    supportState.lastPing = null;
    supportState.lastCheck = null;
    supportState.lastInstall = null;
    toast("UI reset");
  }

  // Defaults from query params
  serverInput.value = normBase(qs.get("server") || "http://localhost:8787");
  channelInput.value = (qs.get("channel") || "stable").toLowerCase();
  currentInput.value = qs.get("current") || "unknown";
  destInput.value = qs.get("dest") || "current";

  updateServerLabel();
  serverInput.addEventListener("input", updateServerLabel);

  pingBtn.onclick = () => ping().catch(fail);
  checkBtn.onclick = () => check().catch(err => { setStatus("Failed"); setFill(100); fail(err); });

  installBtn.onclick = () => install(false).catch(err => { setStatus("Failed"); setFill(100); fail(err); setButtons(true); });
  wipeInstallBtn.onclick = () => install(true).catch(err => { setStatus("Failed"); setFill(100); fail(err); setButtons(true); });

  copyDiagBtn.onclick = () => copyDiagnostics();
  downloadLogBtn.onclick = () => downloadLogs();
  resetUiBtn.onclick = () => resetUi();

  (async () => {
    wlog("Updater loaded.");
    setServerState("warn");
    try {
      await ping();
      await check();
    } catch (e) {
      fail(e);
    }
  })();
</script>
</body>
</html>
