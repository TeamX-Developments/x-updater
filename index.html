<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project X Updater</title>

  <link rel="stylesheet" href="./css/x-main.css">
  <link rel="stylesheet" href="./css/x-forms.css">

  <style>
    :root{--bd:rgba(255,255,255,.12);--card:rgba(255,255,255,.06)}
    body{
      min-height:100vh;margin:0;color:rgba(255,255,255,.92);overflow:hidden;
      background:
        radial-gradient(1200px 800px at 15% 20%, rgba(125,211,252,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 70%, rgba(167,139,250,.16), transparent 55%),
        linear-gradient(180deg, #0b1020 0%, #070a12 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:26px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:18px;border:1px solid var(--bd);background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));
      border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);backdrop-filter:blur(10px)
    }
    .brand{display:flex;align-items:center;gap:12px}
    .dot{
      width:12px;height:12px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 35%, rgba(255,255,255,0) 70%),
                  linear-gradient(180deg, rgba(99,102,241,1), rgba(34,197,94,1));
      box-shadow:0 0 18px rgba(99,102,241,.55),0 0 22px rgba(34,197,94,.25)
    }
    .title{font-size:18px;font-weight:800}
    .sub{font-size:12px;opacity:.75;margin-top:2px}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--bd);
      background:rgba(255,255,255,.05);font-size:12px;display:inline-flex;gap:8px;align-items:center
    }
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin-top:16px}
    .card{
      border:1px solid var(--bd);background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));
      border-radius:18px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.28);backdrop-filter:blur(10px)
    }
    h3{margin:0;font-size:14px;opacity:.9}
    .muted{opacity:.72;font-size:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .meta{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .k{border:1px solid var(--bd);background:rgba(255,255,255,.04);border-radius:14px;padding:10px;min-height:56px}
    .lbl{font-size:11px;opacity:.7}
    .val{margin-top:5px;font-size:13px;font-weight:750;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid var(--bd);background:rgba(255,255,255,.06);color:rgba(255,255,255,.92);
      padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;
      transition:transform .08s ease,background .2s ease,border-color .2s ease,opacity .2s ease
    }
    button:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.2)}
    button:active{transform:translateY(1px)}
    button.primary{background:linear-gradient(180deg, rgba(99,102,241,.45), rgba(34,197,94,.18));border-color:rgba(99,102,241,.55)}
    button:disabled{opacity:.45;cursor:not-allowed}

    .bar{margin-top:12px;border:1px solid var(--bd);background:rgba(0,0,0,.18);border-radius:999px;height:12px;overflow:hidden}
    .fill{height:100%;width:0%;background:linear-gradient(90deg, rgba(99,102,241,1), rgba(34,197,94,1));border-radius:999px;transition:width .25s ease}
    .log{
      margin-top:12px;border:1px solid var(--bd);background:rgba(0,0,0,.18);border-radius:14px;padding:12px;
      height:250px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;line-height:1.45;white-space:pre-wrap
    }
    .minirow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    input{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);
      background:rgba(255,255,255,.05);color:rgba(255,255,255,.92);outline:none
    }
    label{font-size:11px;opacity:.7}
    @media (max-width:860px){.grid{grid-template-columns:1fr}.meta{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Project X Updater</div>
          <div class="sub" id="sub">Uses <code>/v2/updates/check</code> and <code>/v2/updates/install</code>. No fake endpoints.</div>
        </div>
      </div>
      <div class="pill">Server: <span id="serverLbl">…</span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <h3>Update Status</h3>
          <div class="pill" id="statusPill">starting…</div>
        </div>

        <div class="minirow">
          <div style="flex:1;min-width:220px">
            <label>Server (updates)</label>
            <input id="serverInput" placeholder="http://localhost:8787" />
          </div>
          <div style="flex:1;min-width:180px">
            <label>Channel</label>
            <input id="channelInput" placeholder="stable" />
          </div>
          <div style="flex:1;min-width:180px">
            <label>Current version</label>
            <input id="currentInput" placeholder="1.0.0" />
          </div>
          <div style="flex:1;min-width:180px">
            <label>Install dest (folder name)</label>
            <input id="destInput" placeholder="current" />
          </div>
        </div>

        <div class="meta">
          <div class="k"><div class="lbl">Current</div><div class="val" id="curVer">--</div></div>
          <div class="k"><div class="lbl">Latest</div><div class="val" id="latVer">--</div></div>
          <div class="k"><div class="lbl">Published</div><div class="val" id="pub">--</div></div>
          <div class="k"><div class="lbl">Update Available</div><div class="val" id="avail">--</div></div>
        </div>

        <div class="actions">
          <button class="primary" id="pingBtn">Ping</button>
          <button class="primary" id="checkBtn">Check</button>
          <button id="installBtn" disabled>Install</button>
          <button id="wipeInstallBtn" disabled>Wipe + Install</button>
        </div>

        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <div class="row">
          <h3>Release Notes</h3>
          <div class="muted" id="notesLbl">live</div>
        </div>
        <div class="log" id="notes"></div>
      </div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);

  const logEl = el("log");
  const notesEl = el("notes");
  const fillEl = el("fill");
  const statusPill = el("statusPill");

  const pingBtn = el("pingBtn");
  const checkBtn = el("checkBtn");
  const installBtn = el("installBtn");
  const wipeInstallBtn = el("wipeInstallBtn");

  const curVerEl = el("curVer");
  const latVerEl = el("latVer");
  const pubEl = el("pub");
  const availEl = el("avail");

  const serverLbl = el("serverLbl");
  const serverInput = el("serverInput");
  const channelInput = el("channelInput");
  const currentInput = el("currentInput");
  const destInput = el("destInput");

  const qs = new URLSearchParams(location.search);

  function wlog(s){
    const t = new Date().toLocaleTimeString();
    logEl.textContent += `[${t}] ${s}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setFill(p){
    const v = Math.max(0, Math.min(100, Number(p) || 0));
    fillEl.style.width = v + "%";
  }

  function setStatus(text){
    statusPill.textContent = text;
  }

  function getCfg(){
    const server = (serverInput.value || "").trim().replace(/\/+$/, "");
    const channel = (channelInput.value || "").trim().toLowerCase() || "stable";
    const current = (currentInput.value || "").trim() || "unknown";
    const dest = (destInput.value || "").trim() || "current";
    return { server, channel, current, dest };
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache: "no-store" });
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const txt = await res.text();

    if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0,140)}`);
    if (!ct.includes("application/json")) throw new Error(`Expected JSON, got ${ct || "unknown"}: ${txt.slice(0,140)}`);

    return JSON.parse(txt);
  }

  function setButtons(updateAvailable){
    const ok = !!updateAvailable;
    installBtn.disabled = !ok;
    wipeInstallBtn.disabled = !ok;
  }

  async function ping(){
    const { server } = getCfg();
    setStatus("Pinging…");
    setFill(15);

    wlog(`GET ${server}/health`);
    const data = await fetchJson(server + "/health");

    setFill(100);
    setStatus("Online");
    wlog(`OK: ${data.service} @ ${data.port}`);
    return data;
  }

  async function check(){
    const { server, channel, current } = getCfg();
    setStatus("Checking…");
    setButtons(false);
    setFill(10);

    curVerEl.textContent = current;

    const url = `${server}/v2/updates/check?channel=${encodeURIComponent(channel)}&current=${encodeURIComponent(current)}`;
    wlog("GET " + url);

    const res = await fetchJson(url);
    setFill(70);

    latVerEl.textContent = res.latest ?? "--";
    pubEl.textContent = res.published ?? "--";
    notesEl.textContent = res.notes ?? "";
    availEl.textContent = String(!!res.updateAvailable);

    setButtons(!!res.updateAvailable);

    setStatus(res.status || (res.updateAvailable ? "Update available" : "Up to date"));
    setFill(100);
    wlog("Check done.");
    return res;
  }

  async function install(wipe){
    const { server, channel, dest } = getCfg();
    setStatus(wipe ? "Wipe + Installing…" : "Installing…");
    setFill(15);

    const url =
      `${server}/v2/updates/install?channel=${encodeURIComponent(channel)}&dest=${encodeURIComponent(dest)}&wipe=${wipe ? "1" : "0"}`;

    wlog("GET " + url);
    const res = await fetchJson(url);

    setFill(100);
    if (res.ok) {
      setStatus("Installed");
      wlog(`Installed ${res.latest || ""} to ${res.installed_to}`);
      wlog(`Entries extracted: ${res.entries}`);
    } else {
      setStatus("Failed");
      wlog("Install failed: " + (res.error || "unknown"));
    }
    return res;
  }

  // Defaults
  const defaultServer = (qs.get("server") || "http://localhost:8787").replace(/\/+$/, "");
  const defaultChannel = (qs.get("channel
