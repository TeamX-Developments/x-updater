<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Updater</title>

  <link rel="stylesheet" href="./css/x-main.css">
  <link rel="stylesheet" href="./css/x-forms.css">

  <style>
    :root{--bd:rgba(255,255,255,.12);--card:rgba(255,255,255,.06)}
    body{
      min-height:100vh;margin:0;color:rgba(255,255,255,.92);overflow:hidden;
      background:
        radial-gradient(1200px 800px at 15% 20%, rgba(125,211,252,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 70%, rgba(167,139,250,.16), transparent 55%),
        linear-gradient(180deg, #0b1020 0%, #070a12 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:26px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:18px;border:1px solid var(--bd);background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));
      border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);backdrop-filter:blur(10px)
    }
    .brand{display:flex;align-items:center;gap:12px}
    .dot{
      width:12px;height:12px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 35%, rgba(255,255,255,0) 70%),
                  linear-gradient(180deg, rgba(99,102,241,1), rgba(34,197,94,1));
      box-shadow:0 0 18px rgba(99,102,241,.55),0 0 22px rgba(34,197,94,.25)
    }
    .title{font-size:18px;font-weight:800}
    .sub{font-size:12px;opacity:.75;margin-top:2px}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--bd);
      background:rgba(255,255,255,.05);font-size:12px;display:inline-flex;gap:8px;align-items:center
    }
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin-top:16px}
    .card{
      border:1px solid var(--bd);background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));
      border-radius:18px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.28);backdrop-filter:blur(10px)
    }
    h3{margin:0;font-size:14px;opacity:.9}
    .muted{opacity:.72;font-size:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .meta{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .k{border:1px solid var(--bd);background:rgba(255,255,255,.04);border-radius:14px;padding:10px;min-height:56px}
    .lbl{font-size:11px;opacity:.7}
    .val{margin-top:5px;font-size:13px;font-weight:750;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid var(--bd);background:rgba(255,255,255,.06);color:rgba(255,255,255,.92);
      padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;
      transition:transform .08s ease,background .2s ease,border-color .2s ease,opacity .2s ease
    }
    button:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.2)}
    button:active{transform:translateY(1px)}
    button.primary{background:linear-gradient(180deg, rgba(99,102,241,.45), rgba(34,197,94,.18));border-color:rgba(99,102,241,.55)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .bar{margin-top:12px;border:1px solid var(--bd);background:rgba(0,0,0,.18);border-radius:999px;height:12px;overflow:hidden}
    .fill{height:100%;width:0%;background:linear-gradient(90deg, rgba(99,102,241,1), rgba(34,197,94,1));border-radius:999px;transition:width .25s ease}
    .log{
      margin-top:12px;border:1px solid var(--bd);background:rgba(0,0,0,.18);border-radius:14px;padding:12px;
      height:250px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;line-height:1.45;white-space:pre-wrap
    }
    @media (max-width:860px){.grid{grid-template-columns:1fr}.meta{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Updater</div>
          <div class="sub" id="sub">Talking to your update server… hopefully it talks back.</div>
        </div>
      </div>
      <div class="pill">Server: <span id="serverLbl">…</span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <h3>Update Status</h3>
          <div class="pill" id="statusPill">…</div>
        </div>

        <div class="meta">
          <div class="k"><div class="lbl">Current</div><div class="val" id="curVer">unknown</div></div>
          <div class="k"><div class="lbl">Latest</div><div class="val" id="latVer">…</div></div>
          <div class="k"><div class="lbl">Published</div><div class="val" id="pub">…</div></div>
          <div class="k"><div class="lbl">Channel</div><div class="val" id="chan">stable</div></div>
        </div>

        <div class="actions">
          <button class="primary" id="checkBtn">Check</button>
          <button id="downloadBtn" disabled>Download</button>
          <button id="installBtn" disabled>Install</button>
        </div>

        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <div class="row">
          <h3>Release Notes</h3>
          <div class="muted">live</div>
        </div>
        <div class="log" id="notes"></div>
      </div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id)
  const logEl = el("log")
  const notesEl = el("notes")
  const fillEl = el("fill")
  const statusPill = el("statusPill")

  const checkBtn = el("checkBtn")
  const downloadBtn = el("downloadBtn")
  const installBtn = el("installBtn")

  const curVerEl = el("curVer")
  const latVerEl = el("latVer")
  const pubEl = el("pub")
  const chanEl = el("chan")

  const qs = new URLSearchParams(location.search)
  const channel = (qs.get("channel") || "stable").toLowerCase()
  chanEl.textContent = channel

  const server = qs.get("server") || "http://localhost:3300"
  el("serverLbl").textContent = server

  function wlog(s){
    const t = new Date().toLocaleTimeString()
    logEl.textContent += `[${t}] ${s}\n`
    logEl.scrollTop = logEl.scrollHeight
  }

  function setFill(p){
    const v = Math.max(0, Math.min(100, Number(p) || 0))
    fillEl.style.width = v + "%"
  }

  function setStatus(text){
    statusPill.textContent = text
  }

  async function post(path, body){
    const r = await fetch(server + path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {})
    })
    if (!r.ok) throw new Error(path + " failed: " + r.status)
    return r.json().catch(() => ({}))
  }

  async function push(event, data){
    try{
      await post("/v1/updates/report", {
        event,
        data: data || {},
        ts: Date.now(),
        page: location.href,
        channel
      })
    }catch{}
  }

  function openStream(){
    try{
      const url = server + "/v1/updates/stream?channel=" + encodeURIComponent(channel) + "&t=" + Date.now()
      const es = new EventSource(url)

      es.addEventListener("log", (e) => {
        const msg = safeParse(e.data)
        if (msg && msg.text) wlog(msg.text)
      })

      es.addEventListener("progress", (e) => {
        const msg = safeParse(e.data)
        if (msg && typeof msg.percent === "number") setFill(msg.percent)
      })

      es.addEventListener("state", (e) => {
        const msg = safeParse(e.data)
        if (msg && msg.status) setStatus(msg.status)
        if (msg && msg.latest) latVerEl.textContent = msg.latest
        if (msg && msg.published) pubEl.textContent = msg.published
        if (msg && msg.notes != null) notesEl.textContent = msg.notes
        if (msg && typeof msg.updateAvailable === "boolean"){
          downloadBtn.disabled = !msg.updateAvailable
          installBtn.disabled = !msg.updateAvailable
        }
      })

      es.onerror = () => {
        wlog("Stream disconnected")
      }

      wlog("Stream connected")
      return es
    }catch(err){
      wlog("Stream failed: " + (err?.message || String(err)))
      return null
    }
  }

  function safeParse(s){
    try{ return JSON.parse(s) }catch{ return null }
  }

  async function getCurrentVersion(){
    return qs.get("current") || "unknown"
  }

  async function check(){
    setFill(10)
    setStatus("Checking…")
    downloadBtn.disabled = true
    installBtn.disabled = true

    const current = await getCurrentVersion()
    curVerEl.textContent = current

    wlog("POST /v1/updates/check")
    await push("ui_check_clicked", { current })

    const res = await post("/v1/updates/check", { channel, current })
    setFill(45)

    if (res.current) curVerEl.textContent = res.current
    if (res.latest) latVerEl.textContent = res.latest
    if (res.published) pubEl.textContent = res.published
    if (res.notes != null) notesEl.textContent = res.notes
    setStatus(res.status || (res.updateAvailable ? "Update available" : "Up to date"))

    downloadBtn.disabled = !res.updateAvailable
    installBtn.disabled = !res.updateAvailable

    setFill(100)
    wlog("Check done")
    await push("check_result", res)
  }

  async function download(){
    setStatus("Downloading…")
    setFill(5)
    wlog("POST /v1/updates/download")
    await push("ui_download_clicked", { latest: latVerEl.textContent })

    const res = await post("/v1/updates/download", { channel, version: latVerEl.textContent })
    wlog(res.message || "Download started")
    await push("download_started", res)
  }

  async function install(){
    setStatus("Installing…")
    wlog("POST /v1/updates/install")
    await push("ui_install_clicked", { latest: latVerEl.textContent })

    const res = await post("/v1/updates/install", { channel, version: latVerEl.textContent })
    wlog(res.message || "Install started")
    await push("install_started", res)
  }

  checkBtn.onclick = () => check().catch(e => {
    setStatus("Failed")
    setFill(100)
    wlog(e?.message || String(e))
    push("check_failed", { error: e?.message || String(e) })
  })

  downloadBtn.onclick = () => download().catch(e => {
    setStatus("Failed")
    wlog(e?.message || String(e))
    push("download_failed", { error: e?.message || String(e) })
  })

  installBtn.onclick = () => install().catch(e => {
    setStatus("Failed")
    wlog(e?.message || String(e))
    push("install_failed", { error: e?.message || String(e) })
  })

  push("page_loaded", { ua: navigator.userAgent }).catch(()=>{})
  openStream()
  check().catch(e => { wlog(e?.message || String(e)) })
</script>
</body>
</html>
